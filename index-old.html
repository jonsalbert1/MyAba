<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>myABA ‚Äî Single File</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand-2:#1e40af;
      --ok:#16a34a;
      --bad:#dc2626;
      --ring:rgba(37,99,235,.25);
      --shadow: 0 10px 20px rgba(0,0,0,.07), 0 6px 6px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:linear-gradient(180deg,#fafafc, #eef2ff 35%, #f7f7fb 100%);
    }
    a{color:var(--brand);text-decoration:none}
    a:hover{color:var(--brand-2);text-decoration:underline}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.75);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid #e5e7eb;
    }
    .nav{
      max-width:1100px;margin:0 auto;display:flex;gap:16px;align-items:center;
      padding:12px 20px;
    }
    .brand{font-weight:800;letter-spacing:.2px}
    .spacer{flex:1}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      box-shadow:var(--shadow); transition:.15s transform ease;
      font-weight:600; gap:8px; cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--brand-2)}
    .btn.ghost{background:transparent;border-color:transparent;box-shadow:none;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .hero{
      padding:56px 24px 36px;
      max-width:1100px;margin:0 auto;
      display:grid; grid-template-columns:1fr; gap:20px;
    }
    .hero h1{font-size:clamp(28px,4vw,40px);margin:0 0 8px}
    .hero p{color:var(--muted);margin:0}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-top:24px}
    .card{
      background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:18px;
      box-shadow:var(--shadow); min-height:120px; display:flex; flex-direction:column; gap:10px;
    }
    .card h3{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){.two{grid-template-columns:1fr}}
    .field{display:grid; gap:6px}
    .input,.select,.textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      outline:none; box-shadow:inset 0 0 0 1px transparent;
    }
    .input:focus,.select:focus,.textarea:focus{box-shadow:0 0 0 6px var(--ring); border-color:var(--brand)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-weight:600;font-size:12px}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:600;font-size:12px}
    .kpi{font-weight:800;font-size:22px}
    .center{display:flex;align-items:center;justify-content:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .choices{display:grid; gap:10px}
    .choice{
      border:1px solid #e5e7eb; border-radius:12px; padding:12px; cursor:pointer; background:#fff;
    }
    .choice.correct{border-color:var(--ok); background:#ecfdf5}
    .choice.wrong{border-color:var(--bad); background:#fef2f2}
    .toast{padding:10px 12px;border-radius:10px;font-weight:700}
    .toast.ok{background:#ecfdf5;color:#166534;border:1px solid #86efac}
    .toast.bad{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .timer{
      font-variant-numeric:tabular-nums;
      font-size:32px;font-weight:900; letter-spacing:1px;
    }
    .flip{
      background:#fff; border:1px solid #e5e7eb;border-radius:16px; padding:20px; min-height:180px;
      display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700; font-size:20px;
      box-shadow:var(--shadow); cursor:pointer;
    }
    .footer{color:var(--muted); font-size:12px; padding:30px 24px}
    .sep{height:1px;background:#e5e7eb;margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%; border-collapse:collapse; font-size:14px}
    .table th,.table td{border:1px solid #e5e7eb; padding:8px 10px}
    .table th{background:#f8fafc;text-align:left}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">myABA</div>
      <div class="spacer"></div>
      <a class="btn ghost" href="#/">Home</a>
      <a class="btn ghost" href="#/flashcards">Flash Cards</a>
      <a class="btn ghost" href="#/quiz">Quiz</a>
      <a class="btn ghost" href="#/safmeds">SAFMEDS</a>
      <a class="btn" href="#/data">Upload & Download</a>
    </nav>
  </header>

  <!-- ROUTES -->
  <main id="route-home" class="wrap">
    <section class="hero">
      <div>
        <h1>Welcome back üëã</h1>
        <p>A clean start. Load decks on the <strong>Upload &amp; Download</strong> page when you‚Äôre ready.</p>
        <div class="cards">
          <div class="card">
            <h3>Flash Cards</h3>
            <div class="row">
              <span class="tag">Deck</span><span id="fc-count" class="kpi">0</span>
            </div>
            <p class="muted">Flip to reveal definitions. Shuffle &amp; track progress.</p>
            <div><a class="btn primary" href="#/flashcards">Open</a></div>
          </div>
          <div class="card">
            <h3>Quiz</h3>
            <div class="row">
              <span class="tag">Items</span><span id="qz-count" class="kpi">0</span>
            </div>
            <p class="muted">Multiple choice with instant feedback and rationales.</p>
            <div><a class="btn primary" href="#/quiz">Start</a></div>
          </div>
          <div class="card">
            <h3>SAFMEDS</h3>
            <div class="row">
              <span class="tag">Uses Flashcards</span>
            </div>
            <p class="muted">Choose a timer (30s/60s/120s), mark correct/incorrect, see results.</p>
            <div><a class="btn primary" href="#/safmeds">Run</a></div>
          </div>
          <div class="card">
            <h3>Upload &amp; Download</h3>
            <p class="muted">Manage your flashcard and quiz decks.</p>
            <div><a class="btn" href="#/data">Manage Data</a></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <main id="route-flashcards" class="wrap hidden">
    <h2>Flash Cards</h2>
    <p class="small">Uses the <strong>Flashcards Deck</strong> stored locally. Upload on the data page if empty.</p>

    <div class="row">
      <button class="btn" id="fc-prev">‚óÄ Prev</button>
      <button class="btn" id="fc-next">Next ‚ñ∂</button>
      <button class="btn" id="fc-shuffle">Shuffle</button>
      <span class="pill"><span id="fc-idx">0</span>/<span id="fc-total">0</span></span>
    </div>

    <div id="fc-card" class="flip" title="Click to flip">Click to flip</div>
    <div class="row">
      <span class="pill" id="fc-front-pill">Front</span>
      <span class="pill" id="fc-domain-pill"></span>
    </div>
  </main>

  <main id="route-quiz" class="wrap hidden">
    <h2>Quiz</h2>
    <p class="small">Multiple choice with instant feedback and rationale.</p>

    <div class="card">
      <div class="stack">
        <div class="row">
          <button class="btn" id="qz-prev">‚óÄ Prev</button>
          <button class="btn" id="qz-next">Next ‚ñ∂</button>
          <button class="btn" id="qz-shuffle">Shuffle</button>
          <span class="pill">Item <span id="qz-idx">0</span>/<span id="qz-total">0</span></span>
        </div>
        <div id="qz-question" class="stack" style="font-weight:700;font-size:18px;"></div>
        <div id="qz-choices" class="choices"></div>
        <div id="qz-feedback" class="hidden"></div>
      </div>
    </div>
  </main>

  <main id="route-safmeds" class="wrap hidden">
    <h2>SAFMEDS</h2>
    <p class="small">Select a timer and run through your <strong>Flashcards Deck</strong>. Tap a card to flip, then mark <em>Correct</em> or <em>Wrong</em>.</p>

    <div class="card">
      <div class="row">
        <label class="row">Duration
          <select id="sf-duration" class="select">
            <option value="30">30s</option>
            <option value="60" selected>60s</option>
            <option value="120">120s</option>
          </select>
        </label>
        <button class="btn primary" id="sf-start">Start</button>
        <span class="timer" id="sf-time">00:00</span>
        <span class="pill">Seen <span id="sf-seen">0</span></span>
        <span class="pill">‚úî <span id="sf-correct">0</span></span>
        <span class="pill">‚úñ <span id="sf-wrong">0</span></span>
      </div>
      <div id="sf-card" class="flip" title="Click to flip">Click Start</div>
      <div class="row">
        <button class="btn" id="sf-correct-btn">‚úî Correct</button>
        <button class="btn" id="sf-wrong-btn">‚úñ Wrong</button>
        <button class="btn" id="sf-skip-btn">‚è≠ Skip</button>
        <button class="btn" id="sf-reset">Reset</button>
      </div>
      <div id="sf-result" class="hidden"></div>
    </div>
  </main>

  <main id="route-data" class="wrap hidden">
    <h2>Upload &amp; Download</h2>
    <div class="grid two">
      <div class="card">
        <h3>Flashcards Deck</h3>
        <p class="small">CSV columns required: <code>term,def</code>. Optional: <code>domain</code>.</p>
        <div class="row">
          <input id="fc-file" type="file" accept=".csv" class="input"/>
          <button class="btn" id="fc-load">Upload CSV</button>
          <button class="btn" id="fc-save">Download CSV</button>
        </div>
        <div class="row">
          <span class="tag">Count</span><span id="fc-manage-count" class="kpi">0</span>
        </div>
        <div class="small">Stored key: <code>flashcards:deck</code></div>
      </div>

      <div class="card">
        <h3>Quiz Deck</h3>
        <p class="small">CSV columns required: <code>question,optionA,optionB,optionC,optionD,answer,rationale</code>. <em>answer</em> must be A/B/C/D.</p>
        <div class="row">
          <input id="qz-file" type="file" accept=".csv" class="input"/>
          <button class="btn" id="qz-load">Upload CSV</button>
          <button class="btn" id="qz-save">Download CSV</button>
        </div>
        <div class="row">
          <span class="tag">Count</span><span id="qz-manage-count" class="kpi">0</span>
        </div>
        <div class="small">Stored key: <code>quiz:deck</code></div>
      </div>
    </div>

    <div class="card">
      <h3>Preview</h3>
      <div class="grid two">
        <div>
          <h4>Flashcards</h4>
          <table class="table" id="fc-preview"></table>
        </div>
        <div>
          <h4>Quiz</h4>
          <table class="table" id="qz-preview"></table>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer center">
    <div>myABA ‚Äî single-file prototype ‚Ä¢ Data saved in your browser (localStorage)</div>
  </footer>

  <script>
    // ---------- Utilities
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const byId = (id)=>document.getElementById(id);

    function shuffleInPlace(a){
      for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}
      return a;
    }

    function csvParse(text){
      // Simple CSV parser (handles commas inside quotes)
      const rows = [];
      let cur = '', inQ = false;
      const push = ()=>rows[rows.length-1].push(cur);
      rows.push([]);
      for(let i=0;i<text.length;i++){
        const c = text[i];
        if(c=='"' ){
          if(inQ && text[i+1]=='"'){ cur+='"'; i++; }
          else inQ = !inQ;
        }else if(c==',' && !inQ){ push(); cur=''; }
        else if((c=='\\n' || c=='\\r') && !inQ){
          if(c=='\\r' && text[i+1]=='\\n') i++;
          push(); cur=''; rows.push([]);
        }else{ cur+=c; }
      }
      push();
      // drop last row if empty
      if(rows.length && rows[rows.length-1].every(x=>x==='')) rows.pop();
      return rows.filter(r=>r.some(x=>x.trim()!==''));
    }

    function toCSV(rows){
      const esc = (v)=> {
        v = (v??'').toString();
        if(/[",\\n\\r]/.test(v)) return '"'+v.replace(/"/g,'""')+'"';
        return v;
      };
      return rows.map(r=>r.map(esc).join(',')).join('\\n');
    }

    function download(filename, text){
      const blob = new Blob([text],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    function fmtTime(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return m+':'+s;
    }

    // ---------- Storage Keys
    const KEY_FC = 'flashcards:deck';
    const KEY_QZ = 'quiz:deck';

    // ---------- Router (hash-based)
    const routes = {
      '/': byId('route-home'),
      '/flashcards': byId('route-flashcards'),
      '/quiz': byId('route-quiz'),
      '/safmeds': byId('route-safmeds'),
      '/data': byId('route-data'),
    };
    function showRoute(){
      const hash = location.hash.replace('#','') || '/';
      Object.values(routes).forEach(el=>el.classList.add('hidden'));
      (routes[hash]||routes['/']).classList.remove('hidden');
      refreshKPIs();
      if(hash==='/data'){ renderPreviews(); }
      if(hash==='/flashcards'){ initFlashcardsView(); }
      if(hash==='/quiz'){ renderQuizItem(); }
      if(hash==='/safmeds'){ resetSafmeds(); }
    }
    window.addEventListener('hashchange', showRoute);
    window.addEventListener('load', showRoute);

    // ---------- KPIs on Home
    function refreshKPIs(){
      const fc = JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      const qz = JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      byId('fc-count').textContent = fc.length;
      byId('qz-count').textContent = qz.length;
      byId('fc-manage-count').textContent = fc.length;
      byId('qz-manage-count').textContent = qz.length;
    }

    // ---------- Flashcards
    let fcDeck = [];
    let fcIndex = 0;
    let fcShowFront = true;

    function loadFcDeck(){
      fcDeck = JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      fcIndex = 0; fcShowFront = true;
      byId('fc-total').textContent = fcDeck.length;
      byId('fc-idx').textContent = fcDeck.length? 1 : 0;
      renderFcCard();
    }

    function renderFcCard(){
      const card = byId('fc-card');
      const domainPill = byId('fc-domain-pill');
      const frontPill = byId('fc-front-pill');
      if(!fcDeck.length){ card.textContent = 'No cards. Upload on the Data page.'; domainPill.textContent=''; return; }
      const item = fcDeck[fcIndex];
      const front = (item.term ?? '').trim();
      const back  = (item.def ?? '').trim();
      const domain= (item.domain ?? '').trim();
      card.textContent = fcShowFront ? front : back;
      frontPill.textContent = fcShowFront ? 'Front' : 'Back';
      domainPill.textContent = domain ? ('Domain: '+domain) : '';
      byId('fc-idx').textContent = fcIndex+1;
      byId('fc-total').textContent = fcDeck.length;
    }

    function initFlashcardsView(){
      loadFcDeck();
    }

    byId('fc-card').addEventListener('click',()=>{ fcShowFront=!fcShowFront; renderFcCard(); });
    byId('fc-next').addEventListener('click',()=>{ if(!fcDeck.length) return; fcIndex=(fcIndex+1)%fcDeck.length; fcShowFront=true; renderFcCard(); });
    byId('fc-prev').addEventListener('click',()=>{ if(!fcDeck.length) return; fcIndex=(fcIndex-1+fcDeck.length)%fcDeck.length; fcShowFront=true; renderFcCard(); });
    byId('fc-shuffle').addEventListener('click',()=>{ if(!fcDeck.length) return; shuffleInPlace(fcDeck); fcIndex=0; fcShowFront=true; renderFcCard(); });

    // ---------- Quiz
    let qzDeck = [];
    let qzIndex = 0;

    function loadQzDeck(){
      qzDeck = JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      qzIndex = 0;
      byId('qz-total').textContent = qzDeck.length;
      byId('qz-idx').textContent = qzDeck.length? 1 : 0;
    }

    function renderQuizItem(){
      loadQzDeck();
      const q = qzDeck[qzIndex];
      const qEl = byId('qz-question');
      const cEl = byId('qz-choices');
      const fb  = byId('qz-feedback');
      qEl.innerHTML = '';
      cEl.innerHTML = '';
      fb.className = 'hidden';
      fb.textContent = '';

      if(!qzDeck.length){
        qEl.innerHTML = '<div class="muted">No quiz items. Upload on the Data page.</div>';
        return;
      }
      qEl.textContent = q.question||'';
      const map = ['A','B','C','D'];
      map.forEach(letter=>{
        const div = document.createElement('div');
        div.className = 'choice';
        div.innerHTML = `<strong>${letter}.</strong> ${q['option'+letter] ?? ''}`;
        div.addEventListener('click',()=>{
          const correct = (q.answer||'').toUpperCase().trim() === letter;
          $$('.choice').forEach(x=>x.classList.remove('correct','wrong'));
          div.classList.add(correct?'correct':'wrong');
          fb.className = 'toast '+(correct?'ok':'bad');
          const base = correct ? 'Correct!' : `Incorrect. Correct answer: ${q.answer?.toUpperCase?.()||''}`;
          fb.textContent = q.rationale ? base + ' ‚Äî ' + q.rationale : base;
        });
        cEl.appendChild(div);
      });
      byId('qz-idx').textContent = qzIndex+1;
      byId('qz-total').textContent = qzDeck.length;
    }

    byId('qz-next').addEventListener('click',()=>{ if(!qzDeck.length) return; qzIndex=(qzIndex+1)%qzDeck.length; renderQuizItem(); });
    byId('qz-prev').addEventListener('click',()=>{ if(!qzDeck.length) return; qzIndex=(qzIndex-1+qzDeck.length)%qzDeck.length; renderQuizItem(); });
    byId('qz-shuffle').addEventListener('click',()=>{ if(!qzDeck.length) return; shuffleInPlace(qzDeck); qzIndex=0; renderQuizItem(); });

    // ---------- SAFMEDS (uses Flashcards deck)
    let sfDeck = [];
    let sfIndex = 0;
    let sfTimer = null;
    let sfRemaining = 0;
    let sfSeen = 0, sfCorrect=0, sfWrong=0;
    let sfFront = true;

    function resetSafmeds(){
      sfDeck = JSON.parse(localStorage.getItem(KEY_FC)||'[]').slice();
      sfIndex = 0; sfFront = true;
      sfSeen=0; sfCorrect=0; sfWrong=0;
      sfRemaining = 0;
      if(sfTimer){ clearInterval(sfTimer); sfTimer=null; }
      byId('sf-time').textContent = fmtTime(0);
      byId('sf-card').textContent = sfDeck.length? 'Click Start' : 'No flashcards loaded.';
      byId('sf-seen').textContent = sfSeen;
      byId('sf-correct').textContent = sfCorrect;
      byId('sf-wrong').textContent = sfWrong;
      byId('sf-result').className='hidden';
      byId('sf-result').textContent='';
    }

    function renderSfCard(){
      const card = byId('sf-card');
      if(!sfDeck.length){ card.textContent='No flashcards loaded.'; return; }
      const item = sfDeck[sfIndex];
      card.textContent = sfFront ? (item.term||'') : (item.def||'');
    }

    byId('sf-card').addEventListener('click',()=>{
      if(!sfDeck.length || sfRemaining<=0) return;
      sfFront = !sfFront; renderSfCard();
    });

    function sfNext(){
      if(!sfDeck.length) return;
      sfIndex = (sfIndex+1)%sfDeck.length;
      sfFront = true;
      sfSeen++; byId('sf-seen').textContent = sfSeen;
      renderSfCard();
    }

    function endSafmeds(){
      if(sfTimer){ clearInterval(sfTimer); sfTimer=null; }
      const total = sfCorrect + sfWrong;
      const acc = total? Math.round((sfCorrect/total)*100) : 0;
      const res = byId('sf-result');
      res.className = 'toast ok';
      res.textContent = `Time! ‚úî ${sfCorrect} ‚Ä¢ ‚úñ ${sfWrong} ‚Ä¢ Accuracy ${acc}% ‚Ä¢ Seen ${sfSeen}`;
    }

    byId('sf-start').addEventListener('click',()=>{
      if(!sfDeck.length){ alert('Load Flashcards deck first (Data page).'); return; }
      resetSafmeds();
      const secs = parseInt(byId('sf-duration').value,10)||60;
      sfRemaining = secs;
      byId('sf-time').textContent = fmtTime(sfRemaining);
      renderSfCard();
      sfTimer = setInterval(()=>{
        sfRemaining--;
        byId('sf-time').textContent = fmtTime(sfRemaining);
        if(sfRemaining<=0){ endSafmeds(); }
      },1000);
    });
    byId('sf-reset').addEventListener('click', resetSafmeds);
    byId('sf-correct-btn').addEventListener('click',()=>{
      if(sfRemaining<=0 || !sfDeck.length) return;
      sfCorrect++; byId('sf-correct').textContent = sfCorrect;
      sfNext();
    });
    byId('sf-wrong-btn').addEventListener('click',()=>{
      if(sfRemaining<=0 || !sfDeck.length) return;
      sfWrong++; byId('sf-wrong').textContent = sfWrong;
      sfNext();
    });
    byId('sf-skip-btn').addEventListener('click',()=>{
      if(sfRemaining<=0 || !sfDeck.length) return;
      sfNext();
    });

    // ---------- Data (Upload/Download/Preview)
    async function readFileText(input){
      const file = input.files?.[0];
      if(!file) return null;
      return await file.text();
    }

    function renderPreviews(){
      // Flashcards
      const fc = JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      const fcTable = byId('fc-preview');
      fcTable.innerHTML='';
      const fcHead = document.createElement('tr');
      ['term','def','domain'].forEach(h=>{
        const th=document.createElement('th'); th.textContent=h; fcHead.appendChild(th);
      });
      fcTable.appendChild(fcHead);
      fc.slice(0,10).forEach(r=>{
        const tr=document.createElement('tr');
        ['term','def','domain'].forEach(k=>{
          const td=document.createElement('td'); td.textContent = r[k]??''; tr.appendChild(td);
        });
        fcTable.appendChild(tr);
      });

      // Quiz
      const qz = JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      const qzTable = byId('qz-preview');
      qzTable.innerHTML='';
      const qzHead = document.createElement('tr');
      ['question','optionA','optionB','optionC','optionD','answer','rationale'].forEach(h=>{
        const th=document.createElement('th'); th.textContent=h; qzHead.appendChild(th);
      });
      qzTable.appendChild(qzHead);
      qz.slice(0,10).forEach(r=>{
        const tr=document.createElement('tr');
        ['question','optionA','optionB','optionC','optionD','answer','rationale'].forEach(k=>{
          const td=document.createElement('td'); td.textContent = r[k]??''; tr.appendChild(td);
        });
        qzTable.appendChild(tr);
      });
      refreshKPIs();
    }

    // Upload Flashcards
    byId('fc-load').addEventListener('click', async ()=>{
      const text = await readFileText(byId('fc-file'));
      if(text==null) return alert('Choose a CSV file.');
      const rows = csvParse(text);
      const [head, ...body] = rows;
      const idx = {
        term: head.indexOf('term'),
        def: head.indexOf('def'),
        domain: head.indexOf('domain'),
      };
      if(idx.term===-1 || idx.def===-1) return alert('CSV must include headers: term,def (optional: domain).');
      const deck = body.map(r=>({term:r[idx.term]||'', def:r[idx.def]||'', domain: idx.domain>=0? (r[idx.domain]||'') : ''}));
      localStorage.setItem(KEY_FC, JSON.stringify(deck));
      alert('Flashcards deck saved.');
      renderPreviews();
    });

    // Download Flashcards
    byId('fc-save').addEventListener('click', ()=>{
      const deck = JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      const rows = [['term','def','domain'], ...deck.map(d=>[d.term||'',d.def||'',d.domain||''])];
      download('flashcards_deck.csv', toCSV(rows));
    });

    // Upload Quiz
    byId('qz-load').addEventListener('click', async ()=>{
      const text = await readFileText(byId('qz-file'));
      if(text==null) return alert('Choose a CSV file.');
      const rows = csvParse(text);
      const [head,...body] = rows;
      const need = ['question','optionA','optionB','optionC','optionD','answer','rationale'];
      const idx = Object.fromEntries(need.map(h=>[h, head.indexOf(h)]));
      if(need.some(h=>idx[h]===-1)) return alert('CSV must include headers: '+need.join(','));
      const deck = body.map(r=>{
        const obj = {}; need.forEach(h=>obj[h]=r[idx[h]]||''); return obj;
      });
      localStorage.setItem(KEY_QZ, JSON.stringify(deck));
      alert('Quiz deck saved.');
      renderPreviews();
    });

    // Download Quiz
    byId('qz-save').addEventListener('click', ()=>{
      const deck = JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      const head = ['question','optionA','optionB','optionC','optionD','answer','rationale'];
      const rows = [head, ...deck.map(d=>head.map(h=>d[h]||''))];
      download('quiz_deck.csv', toCSV(rows));
    });

  </script>
</body>
</html>
