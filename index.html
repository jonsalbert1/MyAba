<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>myABA ‚Äî Robust Uploads + Polished Quiz (Fix Links & Upload)</title>
  <style>
    :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
      --brand:#2563eb; --brand-2:#1e40af; --ok:#16a34a; --bad:#dc2626;
      --ring:rgba(37,99,235,.25); --shadow:0 10px 20px rgba(0,0,0,.07), 0 6px 6px rgba(0,0,0,.06); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);
      background:linear-gradient(180deg,#fafafc,#eef2ff 35%,#f7f7fb 100%);}
    a{color:var(--brand);text-decoration:none}
    a:hover{color:var(--brand-2);text-decoration:underline}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #e5e7eb;}
    .nav{max-width:1100px;margin:0 auto;display:flex;gap:16px;align-items:center;padding:12px 20px;}
    .brand{font-weight:800;letter-spacing:.2px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      box-shadow:var(--shadow);font-weight:600;gap:8px;cursor:pointer;user-select:none;-webkit-user-select:none;}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--brand-2)}
    .btn.ghost{background:transparent;border-color:transparent;box-shadow:none;color:var(--muted)}
    .btn.active{background:#eef2ff;border-color:#c7d2fe;color:#1e3a8a}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .hero{padding:40px 24px 24px;max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:20px}
    .hero h1{font-size:clamp(26px,4vw,38px);margin:0 0 8px}
    .hero p{color:var(--muted);margin:0}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-top:24px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:18px; box-shadow:var(--shadow); min-height:120px; display:flex; flex-direction:column; gap:10px}
    .card h3{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){.two{grid-template-columns:1fr}}
    .select{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:600;font-size:12px}
    .kpi{font-weight:800;font-size:22px}
    .center{display:flex;align-items:center;justify-content:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .flip{background:#fff; border:1px solid #e5e7eb;border-radius:16px; padding:20px; min-height:180px; display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700; font-size:20px; box-shadow:var(--shadow); cursor:pointer}
    .footer{color:var(--muted); font-size:12px; padding:30px 24px}
    .table{width:100%; border-collapse:collapse; font-size:14px}
    .table th,.table td{border:1px solid #e5e7eb; padding:8px 10px}
    .table th{background:#f8fafc;text-align:left}
    .filename{color:var(--muted);font-size:12px}
    .chart-wrap{width:100%; height:320px; background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:var(--shadow); padding:12px}
    svg{width:100%; height:100%}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-weight:600;font-size:12px}

    /* Quiz polish */
    .q-title{font-size:22px;font-weight:800;line-height:1.25}
    .choices{display:grid;gap:12px}
    .choice{border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;background:#fff;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease}
    .choice:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .choice.correct{border-color:#16a34a;background:#ecfdf5}
    .choice.wrong{border-color:#dc2626;background:#fef2f2}
    .toast{padding:10px 12px;border-radius:10px;font-weight:700}
    .toast.ok{background:#ecfdf5;color:#166534;border:1px solid #86efac}
    .toast.bad{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  </style>
</head>
<body>
  <header>
    <nav class="nav" id="top-nav">
      <div class="brand">myABA</div>
      <div class="spacer"></div>
      <a class="btn ghost" href="#/">Home</a>
      <a class="btn ghost" href="#/flashcards">Flash Cards</a>
      <a class="btn ghost" href="#/quiz">Quiz</a>
      <a class="btn ghost" href="#/safmeds">SAFMEDS</a>
      <a class="btn" href="#/data">Upload & Download</a>
    </nav>
  </header>

  <main id="route-home" class="wrap">
    <section class="hero">
      <div>
        <h1>Welcome back üëã</h1>
        <p>Load decks on the <strong>Upload &amp; Download</strong> page, then use Flash Cards, Quiz, or SAFMEDS.</p>
        <div class="cards">
          <div class="card">
            <h3>Flash Cards</h3>
            <div class="row"><span class="pill">Deck</span><span id="fc-count" class="kpi">0</span></div>
            <div class="row"><a class="btn primary" href="#/flashcards">Open</a></div>
          </div>
          <div class="card">
            <h3>Quiz</h3>
            <div class="row"><span class="pill">Items</span><span id="qz-count" class="kpi">0</span></div>
            <div><a class="btn primary" href="#/quiz">Start</a></div>
          </div>
          <div class="card">
            <h3>SAFMEDS</h3>
            <p class="muted">Uses the Flashcards deck. Optional domain filter + graph.</p>
            <div><a class="btn primary" href="#/safmeds">Run</a></div>
          </div>
          <div class="card">
            <h3>Upload &amp; Download</h3>
            <div><a class="btn" href="#/data">Manage Data</a></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <main id="route-flashcards" class="wrap hidden">
    <h2>Flash Cards</h2>
    <div class="row">
      <button class="btn" id="fc-prev">‚óÄ Prev</button>
      <button class="btn" id="fc-next">Next ‚ñ∂</button>
      <button class="btn" id="fc-shuffle">Shuffle</button>
      <span class="pill"><span id="fc-idx">0</span>/<span id="fc-total">0</span></span>
    </div>
    <div id="fc-card" class="flip" title="Click to flip">Click to flip</div>
  </main>

  <main id="route-quiz" class="wrap hidden">
    <h2>Quiz</h2>
    <div class="card">
      <div class="stack">
        <div class="row">
          <button class="btn" id="qz-prev">‚óÄ Prev</button>
          <button class="btn" id="qz-next">Next ‚ñ∂</button>
          <button class="btn" id="qz-shuffle">Shuffle</button>
          <label class="row">Domain
            <select id="qz-domain" class="select"></select>
          </label>
          <span class="pill">Item <span id="qz-idx">0</span>/<span id="qz-total">0</span></span>
        </div>
        <div id="qz-meta" class="row"></div>
        <div id="qz-question" class="q-title"></div>
        <div id="qz-choices" class="choices"></div>
        <div id="qz-feedback" class="hidden"></div>
      </div>
    </div>
  </main>

  <main id="route-safmeds" class="wrap hidden">
    <h2>SAFMEDS</h2>
    <div class="card">
      <div class="row">
        <label class="row">Duration
          <select id="sf-duration" class="select">
            <option value="30">30s</option>
            <option value="60" selected>60s</option>
            <option value="120">120s</option>
          </select>
        </label>
        <label class="row">Domain
          <select id="sf-domain" class="select"></select>
        </label>
        <button class="btn primary" id="sf-start">Start</button>
        <span class="pill">Time <span id="sf-time">00:00</span></span>
        <span class="pill">Deck <span id="sf-deck-size">0</span></span>
        <span class="pill">Seen <span id="sf-seen">0</span></span>
        <span class="pill">‚úî <span id="sf-correct">0</span></span>
        <span class="pill">‚úñ <span id="sf-wrong">0</span></span>
      </div>
      <div id="sf-card" class="flip" title="Click to flip">Click Start</div>
      <div class="row">
        <button class="btn" id="sf-correct-btn">‚úî Correct</button>
        <button class="btn" id="sf-wrong-btn">‚úñ Wrong</button>
        <button class="btn" id="sf-skip-btn">‚è≠ Skip</button>
        <button class="btn" id="sf-reset">Reset</button>
      </div>
      <div id="sf-result" class="hidden"></div>
    </div>

    <div class="card">
      <h3>Results (Date vs Number Correct)</h3>
      <div class="row">
        <button class="btn" id="sf-export">‚¨á Export Sessions (CSV)</button>
        <button class="btn" id="sf-clear">üóë Clear Sessions</button>
        <span class="pill">Sessions: <span id="sf-session-count">0</span></span>
      </div>
      <div class="chart-wrap">
        <svg id="sf-chart" viewBox="0 0 800 320" preserveAspectRatio="none" role="img" aria-label="SAFMEDS results chart"></svg>
      </div>
      <p class="muted">SAFMEDS uses the current Flashcards deck. Filter by domain if your cards include one.</p>
    </div>
  </main>

  <main id="route-data" class="wrap hidden">
    <h2>Upload &amp; Download</h2>
    <div class="grid two">
      <div class="card">
        <h3>Flashcards Deck</h3>
        <p class="muted">CSV headers: <code>term,def</code> (optional <code>domain</code>)</p>
        <div class="row">
          <input id="fc-file" type="file" accept=".csv,text/csv"/>
          <button class="btn" id="fc-load">‚¨Ü Upload CSV</button>
          <button class="btn" id="fc-save">‚¨á Download CSV</button>
        </div>
        <div class="row"><span class="pill">Count</span><span id="fc-manage-count" class="kpi">0</span></div>
      </div>

      <div class="card">
        <h3>Quiz Deck</h3>
        <p class="muted">CSV headers (domain first): <code>domain,question,optionA,optionB,optionC,optionD,answer,rationale</code></p>
        <div class="row">
          <input id="qz-file" type="file" accept=".csv,text/csv"/>
          <button class="btn" id="qz-load">‚¨Ü Upload CSV</button>
          <button class="btn" id="qz-save">‚¨á Download CSV</button>
        </div>
        <div class="row"><span class="pill">Count</span><span id="qz-manage-count" class="kpi">0</span></div>
      </div>
    </div>
    <div class="card">
      <h3>Preview (first 10 rows)</h3>
      <div class="grid two">
        <div><h4>Flashcards</h4><table class="table" id="fc-preview"></table></div>
        <div><h4>Quiz</h4><table class="table" id="qz-preview"></table></div>
      </div>
    </div>
  </main>

  <footer class="footer center"><div>myABA ‚Äî single-file prototype ‚Ä¢ Data saved in your browser (localStorage)</div></footer>

  <script>
    // Guard: surface errors to console
    window.addEventListener('error', (e)=>{ console.log('[myABA error]', e.message); });

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const byId = (id)=>document.getElementById(id);

    function shuffleInPlace(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}

    // --- CSV helpers (fixed) ---
    function stripBOM(s){ return s && s.charCodeAt(0)===0xFEFF ? s.slice(1) : s; }
    function csvParse(text){
      // Normalize CRLF/CR to LF
      text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const rows=[]; let cur='', inQ=false; const push=()=>rows[rows.length-1].push(cur);
      rows.push([]);
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c=='"'){ if(inQ && text[i+1]=='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(c==',' && !inQ){ push(); cur=''; }
        else if(c=='\n' && !inQ){ push(); cur=''; rows.push([]); }
        else { cur+=c; }
      }
      push();
      return rows.filter(r=>r.some(x=>x.trim()!==''));
    }
    function headerIndex(head, names){
      const norm = (s)=>stripBOM((s||'')+'').trim().toLowerCase();
      const H = head.map(norm);
      for(const cand of names){
        const idx = H.indexOf(norm(cand));
        if(idx!==-1) return idx;
      }
      return -1;
    }
    function toCSV(rows){
      const esc=(v)=>{ v=(v??'').toString(); return /[",\n\r]/.test(v)? '"'+v.replace(/"/g,'""')+'"' : v; };
      return rows.map(r=>r.map(esc).join(',')).join('\n');
    }
    function download(filename, text){
      const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    function fmtTime(sec){const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); return m+':'+s;}

    const KEY_FC='flashcards:deck', KEY_QZ='quiz:deck', KEY_SF='safmeds:sessions';

    // Router
    const routes={'/':byId('route-home'),'/flashcards':byId('route-flashcards'),'/quiz':byId('route-quiz'),'/safmeds':byId('route-safmeds'),'/data':byId('route-data')};
    function setActiveLink(hash){ const current=hash||'/'; $$('#top-nav a').forEach(a=>{ const t=a.getAttribute('href').replace('#',''); a.classList.toggle('active', t===current); }); }
    function safe(fn){ try{ fn(); }catch(e){ console.log('router error', e); } }
    function initFlashcardsView(){ safe(loadFcDeck); }
    function showRoute(){ const hash=location.hash.replace('#','')||'/'; Object.values(routes).forEach(el=>el && el.classList.add('hidden')); (routes[hash]||routes['/'])?.classList.remove('hidden'); setActiveLink(hash);
      safe(refreshKPIs); if(hash==='/data') safe(renderPreviews); if(hash==='/flashcards') initFlashcardsView(); if(hash==='/quiz') safe(()=>renderQuizItem(true)); if(hash==='/safmeds'){ safe(initSafmedsDomain); safe(resetSafmeds); safe(renderSfChart);} }
    document.addEventListener('DOMContentLoaded', showRoute);
    window.addEventListener('hashchange', showRoute);
    byId('top-nav')?.addEventListener('click',(e)=>{ const a=e.target.closest?.('a[href^="#/"]'); if(!a) return; e.preventDefault(); const t=a.getAttribute('href'); if(location.hash!==t) location.hash=t; else showRoute(); });

    // KPIs
    function refreshKPIs(){
      const fc=JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      const qz=JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      byId('fc-count') && (byId('fc-count').textContent=fc.length);
      byId('qz-count') && (byId('qz-count').textContent=qz.length);
      byId('fc-manage-count') && (byId('fc-manage-count').textContent=fc.length);
      byId('qz-manage-count') && (byId('qz-manage-count').textContent=qz.length);
      const s=JSON.parse(localStorage.getItem(KEY_SF)||'[]'); byId('sf-session-count') && (byId('sf-session-count').textContent=s.length);
    }

    // Flashcards
    let fcDeck=[], fcIndex=0, fcShowFront=true;
    function loadFcDeck(){ fcDeck=JSON.parse(localStorage.getItem(KEY_FC)||'[]') || []; fcIndex=0; fcShowFront=true; const t=byId('fc-total'), i=byId('fc-idx'); t && (t.textContent=fcDeck.length); i && (i.textContent=fcDeck.length?1:0); renderFcCard(); }
    function renderFcCard(){ const card=byId('fc-card'); if(!card) return; if(!fcDeck.length){ card.textContent='No cards. Upload on the Data page.'; return; } const item=fcDeck[fcIndex]||{}; const front=(item.term??'').toString().trim(); const back=(item.def??'').toString().trim(); card.textContent= fcShowFront ? (front||'‚Äî (empty term)') : (back||'‚Äî (empty def)'); const t=byId('fc-total'), i=byId('fc-idx'); t && (t.textContent=fcDeck.length); i && (i.textContent=fcIndex+1); }
    document.addEventListener('click',(e)=>{
      if(e.target.id==='fc-card'){ fcShowFront=!fcShowFront; renderFcCard(); }
      if(e.target.id==='fc-next'){ if(!fcDeck.length) return; fcIndex=(fcIndex+1)%fcDeck.length; fcShowFront=true; renderFcCard(); }
      if(e.target.id==='fc-prev'){ if(!fcDeck.length) return; fcIndex=(fcIndex-1+fcDeck.length)%fcDeck.length; fcShowFront=true; renderFcCard(); }
      if(e.target.id==='fc-shuffle'){ if(!fcDeck.length) return; fcDeck=fcDeck.slice(); for(let i=fcDeck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[fcDeck[i],fcDeck[j]]=[fcDeck[j],fcDeck[i]];} fcIndex=0; fcShowFront=true; renderFcCard(); }
    });

    // Quiz with domain filter (polished)
    let qzDeck=[], qzFiltered=[], qzIndex=0;
    function loadQzDeck(){ qzDeck=JSON.parse(localStorage.getItem(KEY_QZ)||'[]') || []; }
    function uniqueDomains(deck){ const s=new Set(deck.map(x=>(x.domain||'').trim()).filter(Boolean)); return Array.from(s).sort((a,b)=>a.localeCompare(b)); }
    function buildDomainSelectQuiz(){
      const sel = byId('qz-domain'); if(!sel) return;
      const domains = uniqueDomains(qzDeck);
      const current = sel.value || 'ALL';
      sel.innerHTML='';
      const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='All domains'; sel.appendChild(optAll);
      domains.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o); });
      sel.value = domains.includes(current)? current : 'ALL';
      sel.onchange = ()=>{ qzIndex=0; renderQuizItem(false); };
    }
    function applyFilterQuiz(){
      const sel = byId('qz-domain'); const v = sel? sel.value : 'ALL';
      qzFiltered = (v==='ALL') ? qzDeck.slice() : qzDeck.filter(x=>(x.domain||'')===v);
    }
    function renderQuizItem(rebuildFilter){
      loadQzDeck();
      if(rebuildFilter) buildDomainSelectQuiz();
      applyFilterQuiz();
      const qEl=byId('qz-question'), cEl=byId('qz-choices'), fb=byId('qz-feedback'), meta=byId('qz-meta');
      const t=byId('qz-total'), i=byId('qz-idx');
      if(!qEl||!cEl||!fb||!meta) return;
      qEl.innerHTML=''; cEl.innerHTML=''; fb.className='hidden'; fb.textContent=''; meta.innerHTML='';
      if(!qzFiltered.length){
        qEl.innerHTML='<div class="muted">No quiz items (check your filter or upload deck on the Data page).</div>';
        t && (t.textContent='0'); i && (i.textContent='0');
        return;
      }
      if(qzIndex<0) qzIndex=0; if(qzIndex>=qzFiltered.length) qzIndex=qzFiltered.length-1;
      const q=qzFiltered[qzIndex];
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent = q.domain ? `Domain: ${q.domain}` : 'Domain: ‚Äî'; meta.appendChild(tag);

      qEl.textContent=q.question||'';
      ['A','B','C','D'].forEach(letter=>{
        const div=document.createElement('div'); div.className='choice'; div.innerHTML=`<strong>${letter}.</strong> ${q['option'+letter]??''}`;
        div.addEventListener('click',()=>{
          const correct=(q.answer||'').toUpperCase().trim()===letter;
          $$('.choice').forEach(x=>x.classList.remove('correct','wrong'));
          div.classList.add(correct?'correct':'wrong');
          fb.className='toast '+(correct?'ok':'bad');
          const base= correct? 'Correct!' : `Incorrect. Correct answer: ${q.answer?.toUpperCase?.()||''}`;
          fb.textContent= q.rationale ? base + ' ‚Äî ' + q.rationale : base;
        });
        cEl.appendChild(div);
      });
      t && (t.textContent=qzFiltered.length); i && (i.textContent=qzIndex+1);
    }
    document.addEventListener('click',(e)=>{
      if(e.target.id==='qz-next'){ if(!qzFiltered.length) return; qzIndex=(qzIndex+1)%qzFiltered.length; renderQuizItem(false); }
      if(e.target.id==='qz-prev'){ if(!qzFiltered.length) return; qzIndex=(qzIndex-1+qzFiltered.length)%qzFiltered.length; renderQuizItem(false); }
      if(e.target.id==='qz-shuffle'){ if(!qzFiltered.length) return; shuffleInPlace(qzFiltered); qzIndex=0; renderQuizItem(false); }
    });

    // SAFMEDS ‚Äî uses Flashcards deck + domain filter (same as robust build)
    let sfDeckRaw=[], sfDeck=[], sfIndex=0, sfTimer=null, sfRemaining=0, sfSeen=0, sfCorrect=0, sfWrong=0, sfFront=true;
    function uniqueDomainsFlash(){ const deck=JSON.parse(localStorage.getItem(KEY_FC)||'[]'); const s=new Set(deck.map(x=>(x.domain||'').trim()).filter(Boolean)); return Array.from(s).sort((a,b)=>a.localeCompare(b)); }
    function initSafmedsDomain(){
      const sel = byId('sf-domain'); if(!sel) return;
      const domains = uniqueDomainsFlash();
      const current = sel.value || 'ALL';
      sel.innerHTML='';
      const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='All domains'; sel.appendChild(optAll);
      domains.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o); });
      sel.value = domains.includes(current)? current : 'ALL';
      sel.onchange = ()=>{ resetSafmeds(); };
    }
    function buildSafDeck(){
      sfDeckRaw = JSON.parse(localStorage.getItem(KEY_FC)||'[]').slice();
      const sel = byId('sf-domain'); const v = sel? sel.value : 'ALL';
      sfDeck = (v==='ALL') ? sfDeckRaw : sfDeckRaw.filter(x=> (x.domain||'').trim()===v);
      byId('sf-deck-size') && (byId('sf-deck-size').textContent = sfDeck.length);
    }
    function resetSafmeds(){ buildSafDeck(); sfIndex=0; sfFront=true; sfSeen=0; sfCorrect=0; sfWrong=0; sfRemaining=0;
      if(sfTimer){ clearInterval(sfTimer); sfTimer=null; }
      byId('sf-time') && (byId('sf-time').textContent=fmtTime(0));
      byId('sf-card') && (byId('sf-card').textContent= sfDeck.length? 'Click Start' : 'No flashcards loaded for this filter.');
      byId('sf-seen') && (byId('sf-seen').textContent=sfSeen); byId('sf-correct') && (byId('sf-correct').textContent=sfCorrect); byId('sf-wrong') && (byId('sf-wrong').textContent=sfWrong);
      const r=byId('sf-result'); r && (r.className='hidden', r.textContent='');
    }
    function renderSfCard(){ const card=byId('sf-card'); if(!card) return; if(!sfDeck.length){ card.textContent='No flashcards loaded for this filter.'; return; } const item=sfDeck[sfIndex]; const front=(item.term??'').toString().trim(); const back=(item.def??'').toString().trim(); card.textContent = sfFront ? (front||'‚Äî (empty term)') : (back||'‚Äî (empty def)'); }
    function sfNext(){ if(!sfDeck.length) return; sfIndex=(sfIndex+1)%sfDeck.length; sfFront=true; sfSeen++; byId('sf-seen') && (byId('sf-seen').textContent=sfSeen); renderSfCard(); }
    function endSafmeds(){
      if(sfTimer){ clearInterval(sfTimer); sfTimer=null; }
      const total=sfCorrect+sfWrong, acc= total? Math.round((sfCorrect/total)*100):0;
      const res=byId('sf-result'); if(res){ res.className='toast ok'; res.textContent=`Time! ‚úî ${sfCorrect} ‚Ä¢ ‚úñ ${sfWrong} ‚Ä¢ Accuracy ${acc}% ‚Ä¢ Seen ${sfSeen}`; }
      const sessions = JSON.parse(localStorage.getItem(KEY_SF)||'[]');
      sessions.push({ ts: Date.now(), duration: parseInt(byId('sf-duration')?.value,10)||60, seen: sfSeen, correct: sfCorrect, wrong: sfWrong });
      localStorage.setItem(KEY_SF, JSON.stringify(sessions));
      refreshKPIs();
      renderSfChart();
    }
    document.addEventListener('click',(e)=>{
      if(e.target.id==='sf-card'){ if(!sfDeck.length || sfRemaining<=0) return; sfFront=!sfFront; renderSfCard(); }
      if(e.target.id==='sf-correct-btn'){ if(sfRemaining<=0||!sfDeck.length) return; sfCorrect++; byId('sf-correct') && (byId('sf-correct').textContent=sfCorrect); sfNext(); }
      if(e.target.id==='sf-wrong-btn'){ if(sfRemaining<=0||!sfDeck.length) return; sfWrong++; byId('sf-wrong') && (byId('sf-wrong').textContent=sfWrong); sfNext(); }
      if(e.target.id==='sf-skip-btn'){ if(sfRemaining<=0||!sfDeck.length) return; sfNext(); }
      if(e.target.id==='sf-reset'){ resetSafmeds(); }
      if(e.target.id==='sf-start'){
        if(!sfDeck.length){ alert('Flashcards deck is empty for this domain filter. Load or change filter.'); return; }
        resetSafmeds();
        const secs=parseInt(byId('sf-duration')?.value,10)||60;
        sfRemaining=secs; byId('sf-time') && (byId('sf-time').textContent=fmtTime(sfRemaining)); renderSfCard();
        sfTimer=setInterval(()=>{ sfRemaining--; byId('sf-time') && (byId('sf-time').textContent=fmtTime(sfRemaining)); if(sfRemaining<=0){ endSafmeds(); } },1000);
      }
      if(e.target.id==='sf-export'){ exportSessionsCSV(); }
      if(e.target.id==='sf-clear'){ if(confirm('Clear all SAFMEDS sessions?')){ localStorage.removeItem(KEY_SF); refreshKPIs(); renderSfChart(); } }
    });

    // SAFMEDS Chart
    function renderSfChart(){
      const svg = byId('sf-chart');
      if(!svg) return;
      const sessions = (JSON.parse(localStorage.getItem(KEY_SF)||'[]')||[]).slice().sort((a,b)=>a.ts-b.ts);
      svg.innerHTML='';
      const W=800,H=320;
      if(!sessions.length){
        const msg = document.createElementNS('http://www.w3.org/2000/svg','text');
        msg.setAttribute('x', String(W/2)); msg.setAttribute('y', String(H/2));
        msg.setAttribute('text-anchor','middle'); msg.setAttribute('fill','#6b7280'); msg.setAttribute('font-size','14');
        msg.textContent='No sessions yet. Run SAFMEDS to see your graph.';
        svg.appendChild(msg);
        return;
      }
      const minX=Math.min(...sessions.map(s=>s.ts)), maxX=Math.max(...sessions.map(s=>s.ts));
      const maxY=Math.max(10, ...sessions.map(s=>s.correct||0));
      const xScale=(t)=>60 + ((t-minX)/(maxX-minX||1))*(W-80);
      const yScale=(v)=>20 + (H-60) - ((v)/(maxY||1))*(H-60);
      for(let i=0;i<=6;i++){
        const v=Math.round((maxY*i)/6);
        const y=yScale(v);
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1','60'); line.setAttribute('y1',String(y));
        line.setAttribute('x2',String(W-20)); line.setAttribute('y2',String(y));
        line.setAttribute('stroke','#e5e7eb'); svg.appendChild(line);
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x','52'); t.setAttribute('y', String(y+4)); t.setAttribute('text-anchor','end'); t.setAttribute('fill','#6b7280'); t.setAttribute('font-size','11'); t.textContent=String(v); svg.appendChild(t);
      }
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const dStr = sessions.map((s,i)=> (i?'L':'M') + xScale(s.ts)+','+yScale(s.correct||0)).join(' ');
      path.setAttribute('d', dStr); path.setAttribute('fill','none'); path.setAttribute('stroke','#2563eb'); path.setAttribute('stroke-width','2');
      svg.appendChild(path);
      sessions.forEach(s=>{
        const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', String(xScale(s.ts))); c.setAttribute('cy', String(yScale(s.correct||0))); c.setAttribute('r','3.5'); c.setAttribute('fill','#1e40af'); svg.appendChild(c);
      });
    }
    function exportSessionsCSV(){
      const sessions = JSON.parse(localStorage.getItem(KEY_SF)||'[]');
      const head = ['dateISO','timestamp','duration','seen','correct','wrong'];
      const rows = [head, ...sessions.map(s=>[new Date(s.ts).toISOString(), String(s.ts), String(s.duration), String(s.seen), String(s.correct), String(s.wrong)])];
      download('safmeds_sessions.csv', toCSV(rows));
    }

    // Upload & Download
    async function readFileText(input){
      try{ const f=input.files?.[0]; if(!f) return null; return await f.text(); }
      catch(err){ console.error(err); alert('Could not read the file. Please try again.'); return null; }
    }
    function renderPreviews(){
      const fc=JSON.parse(localStorage.getItem(KEY_FC)||'[]');
      const fcTable=byId('fc-preview'); if(fcTable){ fcTable.innerHTML=''; const head=document.createElement('tr'); ['term','def','domain'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head.appendChild(th); }); fcTable.appendChild(head); (fc||[]).slice(0,10).forEach(r=>{ const tr=document.createElement('tr'); ['term','def','domain'].forEach(k=>{ const td=document.createElement('td'); td.textContent=(r[k]??'').toString(); tr.appendChild(td); }); fcTable.appendChild(tr); }); }
      const qz=JSON.parse(localStorage.getItem(KEY_QZ)||'[]');
      const qzTable=byId('qz-preview'); if(qzTable){ qzTable.innerHTML=''; const head2=document.createElement('tr'); ['domain','question','optionA','optionB','optionC','optionD','answer','rationale'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head2.appendChild(th); }); qzTable.appendChild(head2); (qz||[]).slice(0,10).forEach(r=>{ const tr=document.createElement('tr'); ['domain','question','optionA','optionB','optionC','optionD','answer','rationale'].forEach(k=>{ const td=document.createElement('td'); td.textContent=(r[k]??'').toString(); tr.appendChild(td); }); qzTable.appendChild(tr); }); }
      refreshKPIs();
    }
    document.addEventListener('click', async (e)=>{
      if(e.target.id==='fc-load'){
        const input=byId('fc-file'); const text=await readFileText(input);
        if(text==null){ alert('Choose a CSV, then tap Upload.'); return; }
        const rows=csvParse(text);
        if(!rows.length){ alert('No rows found in CSV.'); return; }
        const head=rows[0].map(c=>stripBOM((c||'').toString()).trim());
        const body=rows.slice(1);
        const idxTerm = headerIndex(head, ['term','front','question','prompt']);
        const idxDef  = headerIndex(head, ['def','definition','back','answer']);
        const idxDom  = headerIndex(head, ['domain','tag','category']);
        if(idxTerm===-1 || idxDef===-1){ alert('CSV must include headers for term/front and def/back.'); return; }
        const deck = body.map(r=>{
          const term=(r[idxTerm]??'').toString().trim();
          const def =(r[idxDef]??'').toString().trim();
          const domain = idxDom>=0 ? (r[idxDom]??'').toString().trim() : '';
          return {term, def, domain};
        }).filter(x=>x.term!=='' || x.def!=='');
        localStorage.setItem(KEY_FC, JSON.stringify(deck));
        alert(`Flashcards deck saved (${deck.length}).`);
        renderPreviews();
      }
      if(e.target.id==='fc-save'){
        const deck=JSON.parse(localStorage.getItem(KEY_FC)||'[]') || [];
        const rows=[['term','def','domain'], ...deck.map(d=>[(d.term||'').toString(),(d.def||'').toString(),(d.domain||'').toString()])];
        download('flashcards_deck.csv', toCSV(rows));
      }
      if(e.target.id==='qz-load'){
        const input=byId('qz-file'); const text=await readFileText(input);
        if(text==null){ alert('Choose a CSV, then tap Upload.'); return; }
        const rows=csvParse(text);
        if(!rows.length){ alert('No rows found in CSV.'); return; }
        const head=rows[0].map(c=>stripBOM((c||'').toString()).trim());
        const body=rows.slice(1);
        const want=['domain','question','optionA','optionB','optionC','optionD','answer','rationale'];
        const idx=Object.fromEntries(want.map(h=>[h, headerIndex(head,[h])]));
        if(want.some(h=>idx[h]===-1)){ alert('CSV must include headers (domain first): '+want.join(',')); return; }
        const deck=body.map(r=>{
          const o={};
          want.forEach(h=> o[h]=(r[idx[h]]??'').toString().trim() );
          return o;
        }).filter(x=>x.question!=='');
        localStorage.setItem(KEY_QZ, JSON.stringify(deck));
        alert(`Quiz deck saved (${deck.length}).`);
        renderPreviews();
        if(!(routes['/quiz']?.classList.contains('hidden'))) renderQuizItem(true);
      }
      if(e.target.id==='qz-save'){
        const deck=JSON.parse(localStorage.getItem(KEY_QZ)||'[]') || [];
        const head=['domain','question','optionA','optionB','optionC','optionD','answer','rationale'];
        const rows=[head, ...deck.map(d=>head.map(h=>(d[h]||'').toString()))];
        download('quiz_deck.csv', toCSV(rows));
      }
    });
  </script>
</body>
</html>
