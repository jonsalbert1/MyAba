<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyABA — Study Suite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
  <style>
    :root{ color-scheme: light; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,0.03); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #d1d5db; border-radius:.75rem; font-weight:600; color:#2563eb; background:#fff; transition:.15s ease; }
    .btn:hover{ background:#eff6ff; }
    .btn:active{ transform:scale(0.99); }
    .btn-primary{ background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-ghost{ border-color:transparent; background:transparent; color:#2563eb; }
    .btn-ghost:hover{ background:#eff6ff; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Toasts -->
  <div id="toastWrap" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" class="text-blue-600"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="1.5"/></svg>
        <h1 class="text-xl font-semibold">MyABA <span class="text-gray-400">Study Suite</span></h1>
      </div>
      <nav class="ml-auto flex gap-1" id="navTabs"></nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Clean Start Page -->
    <section id="panel-home" class="panel">
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="card p-6 lg:col-span-2">
          <h2 class="text-lg font-semibold mb-2">Welcome</h2>
          <p class="text-gray-700">Start by importing a deck. You can upload a <b class="text-blue-600">Full Deck</b> CSV, or a <b class="text-blue-600">Flash Cards</b> CSV with just <span class="font-mono">term,definition</span>. Flashcards are built <b class="text-blue-600">only</b> from the Flash Cards upload to keep them separate from the Full Deck.</p>
          <div class="mt-4 flex flex-wrap gap-2">
            <label class="btn" for="fileInputFull"><b>Upload Full Deck CSV</b></label>
            <label class="btn" for="fileInputFlash"><b>Upload Flash Cards CSV</b></label>
            <button class="btn" id="btnLoadSample"><b>Load Sample</b></button>
            <button class="btn" id="btnClear"><b>Clear Data</b></button>
            <button class="btn" id="btnTplFull"><b>Download Empty Full CSV</b></button>
            <button class="btn" id="btnTplFlash"><b>Download Empty Flash CSV</b></button>
          </div>
        </div>
        <div class="card p-6">
          <h3 class="font-medium mb-2">Quick Links</h3>
          <div class="flex flex-col gap-2">
            <button class="btn" onclick="showPanel('panel-decks')"><b>View Decks</b></button>
            <button class="btn" onclick="showPanel('panel-flash')"><b>Flashcards</b></button>
            <button class="btn" onclick="showPanel('panel-quiz')"><b>Quiz</b></button>
            <button class="btn" onclick="showPanel('panel-results')"><b>Data</b></button>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-decks" class="panel hidden card p-5"></section>
    <section id="panel-flash" class="panel hidden card p-5"></section>
    <section id="panel-quiz" class="panel hidden card p-5"></section>
    <section id="panel-results" class="panel hidden card p-5"></section>
    <section id="panel-import" class="panel hidden card p-5"></section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-gray-500">
    <p>© MyABA Study Suite 2025</p>
  </footer>

  <!-- Hidden inputs for uploads -->
  <input id="fileInputFull" type="file" accept=".csv" class="hidden" />
  <input id="fileInputFlash" type="file" accept=".csv" class="hidden" />

<script>
// ====== Storage & State ======
const LS_KEY_FULL   = 'myaba_studysuite_full_v1';   // Full Deck
const LS_KEY_FLASH  = 'myaba_studysuite_flash_v1';  // Flash Cards
const LS_KEY_RESULTS= 'myaba_studysuite_results_v1';
let itemsFull = [];   // Items from Full Deck CSV
let itemsFlash = [];  // Flash items from Flash Cards CSV (term/definition)
let results   = [];

// ====== Tabs & Navigation ======
const tabs = [
  { id:'panel-home', label:'Home' },
  { id:'panel-decks', label:'Decks' },
  { id:'panel-flash', label:'Flashcards' },
  { id:'panel-quiz', label:'Quiz' },
  { id:'panel-results', label:'Data' },
  { id:'panel-import', label:'Import' },
];
function renderTabs(){
  const nav = document.getElementById('navTabs');
  nav.innerHTML = '';
  tabs.forEach(t=>{
    const b = document.createElement('button');
    b.className='px-3 py-1.5 rounded-xl border border-gray-200 hover:bg-blue-50 data-[active=true]:bg-blue-600 data-[active=true]:text-white font-semibold text-blue-600';
    b.textContent=t.label; b.dataset.target=t.id; b.onclick=()=>showPanel(t.id);
    nav.appendChild(b);
  });
}
function showPanel(id){
  const panels = document.querySelectorAll('.panel');
  panels.forEach(p=> p.classList.add('hidden'));
  const target = document.getElementById(id);
  if(target){ target.classList.remove('hidden'); }
  // update active tab state
  document.querySelectorAll('#navTabs button').forEach(b=>{
    b.dataset.active = (b.dataset.target===id) ? 'true' : 'false';
  });
  // lazy renders
  if(id==='panel-decks') renderDecks();
  if(id==='panel-flash') renderFlash();
  if(id==='panel-quiz') renderQuizSetup();
  if(id==='panel-results') renderData();
  if(id==='panel-import') renderImport();
}

// ====== Toasts ======
function toast(msg, type='info'){ // type: info, ok, warn, error
  const wrap=document.getElementById('toastWrap');
  const base='card px-4 py-3 border flex items-start gap-3 min-w-[260px]';
  const colors = {
    info:  'bg-blue-50 border-blue-200 text-blue-800',
    ok:    'bg-green-50 border-green-200 text-green-800',
    warn:  'bg-yellow-50 border-yellow-200 text-yellow-800',
    error: 'bg-red-50 border-red-200 text-red-800'
  };
  const d=document.createElement('div'); d.className = base+' '+(colors[type]||colors.info);
  d.innerHTML = `<div class='font-semibold'>${type==='ok'?'Success': type.charAt(0).toUpperCase()+type.slice(1)}</div><div class='text-sm'>${msg}</div>`;
  wrap.appendChild(d);
  setTimeout(()=>{ d.classList.add('opacity-0','transition'); setTimeout(()=>d.remove(), 300); }, 2500);
}

// ====== Persistence ======
function save(){
  localStorage.setItem(LS_KEY_FULL, JSON.stringify(itemsFull));
  localStorage.setItem(LS_KEY_FLASH, JSON.stringify(itemsFlash));
  localStorage.setItem(LS_KEY_RESULTS, JSON.stringify(results));
}
function load(){
  try{itemsFull = JSON.parse(localStorage.getItem(LS_KEY_FULL)||'[]');}catch{itemsFull=[];}
  try{itemsFlash= JSON.parse(localStorage.getItem(LS_KEY_FLASH)||'[]');}catch{itemsFlash=[];}
  try{results   = JSON.parse(localStorage.getItem(LS_KEY_RESULTS)||'[]');}catch{results=[];}
}
function clearAll(){ if(!confirm('Clear all items and results?')) return; itemsFull=[]; itemsFlash=[]; results=[]; save(); renderAll(); showPanel('panel-home'); toast('All data cleared.','info'); }

// ====== CSV Parsing ======
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){
        if(text[i+1]==='"'){field+='"'; i+=2; continue;}
        inQ=false; i++; continue;
      }
      field+=c; i++; continue;
    } else {
      if(c==='"'){inQ=true; i++; continue;}
      if(c===','){row.push(field.trim()); field=''; i++; continue;}
      if(c==='\n'||c==='\r'){
        if(field!==''||row.length>0){ row.push(field.trim()); rows.push(row); row=[]; field=''; }
        if(c==='\r'&&text[i+1]==='\n') i++;
        i++; continue;
      }
      field+=c; i++; continue;
    }
  }
  if(field!==''||row.length>0){ row.push(field.trim()); rows.push(row); }
  return rows.filter(r=>r.some(cell=>cell!==''));
}

// Full deck (force MC): domain,question,a,b,c,d,answer,rationale
function rowsToItems_Full(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h=>h.toLowerCase());
  const idx = { domain: header.indexOf('domain'), question: header.indexOf('question'), a: header.indexOf('a'), b: header.indexOf('b'), c: header.indexOf('c'), d: header.indexOf('d'), answer: header.indexOf('answer'), rationale: header.indexOf('rationale') };
  if(idx.question===-1 || idx.answer===-1) throw new Error('Missing required column: question or answer');
  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r]; if(!row[idx.question]) continue;
    out.push({ id: crypto.randomUUID(), domain: idx.domain>-1 ? row[idx.domain] : '', type:'MC', question: row[idx.question], options:{ A: idx.a>-1? row[idx.a]:'', B: idx.b>-1? row[idx.b]:'', C: idx.c>-1? row[idx.c]:'', D: idx.d>-1? row[idx.d]:'' }, answer: (row[idx.answer]||'').toString().trim().toUpperCase(), rationale: idx.rationale>-1 ? row[idx.rationale] : '' });
  }
  return out;
}

// Flash-only: term,definition
function rowsToItems_FlashOnly(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h=>h.toLowerCase());
  const iTerm = header.indexOf('term');
  const iDef  = header.indexOf('definition');
  if(iTerm===-1 || iDef===-1) throw new Error('Flash Cards CSV must have headers: term, definition');
  const out=[];
  for(let r=1;r<rows.length;r++){
    const term = rows[r][iTerm]; const def = rows[r][iDef];
    if(!term) continue;
    out.push({ id: crypto.randomUUID(), domain:'', type:'FLASH', question: term, options:{A:'',B:'',C:'',D:''}, answer: def||'', rationale:'' });
  }
  return out;
}

function mergeItems(oldArr, newArr){
  const key=o=> (o.type+'|'+(o.question||'')).trim().toLowerCase();
  const seen=new Set(oldArr.map(key));
  const merged=[...oldArr];
  for(const n of newArr){ if(!seen.has(key(n))) merged.push(n); }
  return merged;
}

// ====== Import Panel ======
function renderImport(){
  const el=document.getElementById('panel-import');
  el.innerHTML=`
    <h2 class="text-lg font-semibold mb-2">Import Options</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="font-medium mb-1">Full Deck</div>
        <p class="text-sm text-gray-600 mb-3">CSV headers: <span class="font-mono">domain,question,a,b,c,d,answer,rationale</span></p>
        <label class="btn" for="fileInputFull"><b>Upload Full Deck CSV</b></label>
      </div>
      <div class="card p-4">
        <div class="font-medium mb-1">Flash Cards</div>
        <p class="text-sm text-gray-600 mb-3">CSV headers: <span class="font-mono">term,definition</span></p>
        <label class="btn" for="fileInputFlash"><b>Upload Flash Cards CSV</b></label>
      </div>
    </div>
    <div class="mt-4 flex gap-2">
      <button class="btn" onclick="downloadJSON()"><b>Export JSON</b></button>
      <button class="btn" onclick="downloadCSV_Full()"><b>Export Full CSV</b></button>
      <button class="btn" onclick="downloadCSV_Flash()"><b>Export Flash CSV</b></button>
      <button class="btn" id="btnTplFull2"><b>Empty Full CSV</b></button>
      <button class="btn" id="btnTplFlash2"><b>Empty Flash CSV</b></button>
      <button class="btn" id="btnClear2"><b>Clear Data</b></button>
    </div>
  `;
  document.getElementById('btnClear2').onclick=clearAll;
  const btnTplFull2=document.getElementById('btnTplFull2');
  const btnTplFlash2=document.getElementById('btnTplFlash2');
  if(btnTplFull2) btnTplFull2.addEventListener('click', downloadTemplateFull);
  if(btnTplFlash2) btnTplFlash2.addEventListener('click', downloadTemplateFlash);
}

// ====== Decks Panel ======
let currentDomainFilter='';
function renderDecks(){
  const el=document.getElementById('panel-decks');
  const countFull = itemsFull.length; const countFlash = itemsFlash.length;
  const domains=[...new Set(itemsFull.map(i=>i.domain).filter(Boolean))];
  el.innerHTML=`
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Decks <span class="text-gray-400">(Full Deck: ${countFull} • Flash Cards: ${countFlash})</span></h2>
      <div class="flex gap-2">
        <input id="searchDeck" class="px-3 py-2 border rounded-xl" placeholder="Search full deck..." />
        <button class="btn" onclick="downloadJSON()"><b>Export JSON</b></button>
        <button class="btn" onclick="downloadCSV_Full()"><b>Full CSV</b></button>
        <button class="btn" onclick="downloadCSV_Flash()"><b>Flash CSV</b></button>
        <button class="btn" onclick="showPanel('panel-import')"><b>Import</b></button>
        <button class="btn btn-primary" onclick="showPanel('panel-quiz')"><b>Start Quiz</b></button>
      </div>
    </div>
    <div class="flex flex-wrap gap-2 mb-4">
      <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">Full Deck</span>
      <span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-200">Flash Cards</span>
      <div class="ml-auto flex gap-2">
        <button class="btn btn-ghost" onclick="filterDomain('')"><b>All Domains</b></button>
        ${domains.map(d=>`<button class='btn btn-ghost' onclick=\"filterDomain('${d.replace(/"/g,'&quot;')}')\"><b>${d}</b></button>`).join('')}
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div class="card p-4">
        <div class="font-medium mb-2">Full Deck</div>
        <div id="deckListFull" class="space-y-3"></div>
      </div>
      <div class="card p-4">
        <div class="font-medium mb-2">Flash Cards (Term → Definition)</div>
        <div id="deckListFlash" class="space-y-3"></div>
      </div>
    </div>
  `;
  populateDeckListFull();
  populateDeckListFlash();
  el.querySelector('#searchDeck').addEventListener('input', populateDeckListFull);
}
function filterDomain(d){ currentDomainFilter=d; populateDeckListFull(); }
function populateDeckListFull(){
  const list=document.getElementById('deckListFull');
  const term=(document.getElementById('searchDeck')?.value||'').toLowerCase();
  const filtered=itemsFull.filter(i=>{ const ok=currentDomainFilter? i.domain===currentDomainFilter : true; const text=[i.domain,i.question,i.options?.A,i.options?.B,i.options?.C,i.options?.D,i.rationale].join(' ').toLowerCase(); return ok && text.includes(term); });
  list.innerHTML = filtered.map(i=>`
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div class="text-xs text-gray-500">${i.domain? 'Domain: '+i.domain:''}</div>
        <button class="text-sm text-blue-600 hover:underline font-semibold" onclick="deleteItem('${i.id}','full')">Delete</button>
      </div>
      <div class="font-medium mt-1">${escapeHTML(i.question)}</div>
      <ol class="mt-2 grid grid-cols-2 gap-2 text-sm">
        ${['A','B','C','D'].map(k=> i.options?.[k]? `<li class='border rounded-lg px-2 py-1'><span class='text-gray-500 mr-1'>${k}.</span><b>${escapeHTML(i.options[k])}</b></li>`:'').join('')}
      </ol>
      <div class="mt-2 text-sm"><span class="px-2 py-0.5 rounded-full bg-green-50 border border-green-200">Answer: ${i.answer||'-'}</span></div>
      ${i.rationale? `<details class='mt-2 text-sm text-gray-700'><summary class='cursor-pointer text-gray-600'>Rationale</summary><div class='mt-1'>${escapeHTML(i.rationale)}</div></details>`:''}
    </div>`).join('') || '<div class="text-sm text-gray-500">No full-deck items.</div>';
}
function populateDeckListFlash(){
  const list=document.getElementById('deckListFlash');
  list.innerHTML = itemsFlash.map(i=>`
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div class="text-xs text-gray-500">Flash Card</div>
        <button class="text-sm text-blue-600 hover:underline font-semibold" onclick="deleteItem('${i.id}','flash')">Delete</button>
      </div>
      <div class="font-medium mt-1">${escapeHTML(i.question)}</div>
      <div class='mt-2 text-sm text-gray-700'><span class='text-gray-500'>Definition:</span> <b>${escapeHTML(i.answer)}</b></div>
    </div>`).join('') || '<div class="text-sm text-gray-500">No flash terms. Upload a Flash Cards CSV.</div>';
}
function deleteItem(id, which){
  if(!confirm('Delete this item?')) return;
  if(which==='full'){ itemsFull = itemsFull.filter(i=>i.id!==id); }
  else { itemsFlash = itemsFlash.filter(i=>i.id!==id); }
  save(); populateDeckListFull(); populateDeckListFlash(); renderDecks();
}

// ====== Flashcards Panel (Flash‑only data) ======
let flashIndex=0, flashOrder=[];
function renderFlash(){
  const el=document.getElementById('panel-flash');
  if(!itemsFlash.length){ el.innerHTML=emptyState('No flash terms yet. Go to Home → Upload Flash Cards CSV.'); return; }
  if(!flashOrder.length){ flashOrder=shuffle([...itemsFlash.keys()]); flashIndex=0; }
  const itm=itemsFlash[flashOrder[flashIndex]];
  el.innerHTML=`
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Flash Cards</h2>
      <div class="flex gap-2">
        <button class="btn" onclick="flashPrev()"><b>Prev</b></button>
        <button class="btn" onclick="flashNext()"><b>Next</b></button>
        <button class="btn" onclick="flashShuffle()"><b>Shuffle</b></button>
      </div>
    </div>
    <div class="card p-6">
      <div class="text-xs text-gray-500">Term</div>
      <div class="mt-2 text-lg font-medium">${escapeHTML(itm.question)}</div>
      <details class="mt-3"><summary class="cursor-pointer text-blue-600 font-semibold">Show Definition</summary>
        <div class="mt-2 text-gray-800">${escapeHTML(itm.answer)}</div>
      </details>
    </div>`;
}
function flashPrev(){ if(flashIndex>0) flashIndex--; renderFlash(); }
function flashNext(){ if(flashIndex<flashOrder.length-1) flashIndex++; renderFlash(); }
function flashShuffle(){ flashOrder=shuffle([...itemsFlash.keys()]); flashIndex=0; renderFlash(); }

// ====== Quiz (Full Deck ONLY) ======
let quizState=null;
function renderQuizSetup(){
  const el=document.getElementById('panel-quiz');
  const pool = itemsFull;
  if(!pool.length){ el.innerHTML=emptyState('No full-deck items. Upload a Full Deck CSV.'); return; }
  const domains=[...new Set(pool.map(i=>i.domain).filter(Boolean))];
  el.innerHTML=`
    <h2 class="text-lg font-semibold mb-3">Quiz</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <label class="block text-sm mb-1">Domain (optional)</label>
        <select id="quizDomain" class="w-full px-3 py-2 border rounded-xl">
          <option value="">All</option>
          ${domains.map(d=>`<option value="${escapeHTML(d)}">${escapeHTML(d)}</option>`).join('')}
        </select>
      </div>
      <div class="card p-4">
        <label class="block text-sm mb-1">Number of Questions</label>
        <input id="quizCount" type="number" min="1" max="${pool.length}" value="10" class="w-full px-3 py-2 border rounded-xl" />
      </div>
    </div>
    <div class="mt-4 flex gap-2">
      <button class="btn btn-primary" onclick="startQuiz()"><b>Start</b></button>
      <button class="btn" onclick="showPanel('panel-decks')"><b>Back to Decks</b></button>
    </div>
    <div id="quizLive" class="mt-6"></div>`;
}
function startQuiz(){
  const domain=document.getElementById('quizDomain').value||'';
  const pool = itemsFull.filter(i=> domain? i.domain===domain : true);
  const n=Math.max(1, Math.min(parseInt(document.getElementById('quizCount').value||'10',10), pool.length));
  const order=shuffle(pool).slice(0,n); quizState={ order, idx:0, answers:{}, start:Date.now() }; renderQuizLive();
}
function renderQuizLive(){
  const wrap=document.getElementById('quizLive'); if(!quizState){ wrap.innerHTML=''; return; }
  if(quizState.idx>=quizState.order.length){
    const elapsed=Math.round((Date.now()-quizState.start)/1000);
    const score=quizState.order.reduce((acc,itm,idx)=>{ const user=quizState.answers[idx]; const ok=(user===itm.answer); return acc+(ok?1:0); },0);
    const result={ id:crypto.randomUUID(), date:new Date().toISOString(), total:quizState.order.length, score, elapsed, domain:document.getElementById('quizDomain').value||'', detail:quizState.order.map((itm,idx)=>({ qid:itm.id, user:quizState.answers[idx]||'', correct:itm.answer })) };
    results.unshift(result); save();
    wrap.innerHTML=`
      <div class="card p-5">
        <div class="text-lg font-semibold">Done!</div>
        <div class="mt-1 text-gray-700">Score: ${score} / ${quizState.order.length} • Time: ${elapsed}s</div>
        <div class="mt-4 flex gap-2">
          <button class="btn" onclick="reviewLastResult('${result.id}')"><b>Review & Rationales</b></button>
          <button class="btn btn-primary" onclick="startQuiz()"><b>Retake</b></button>
          <button class="btn" onclick="showPanel('panel-results')"><b>View Data</b></button>
        </div>
      </div>`;
    toast('Quiz completed. Results saved.','ok');
    return;
  }
  const idx=quizState.idx; const itm=quizState.order[idx];
  wrap.innerHTML=`
    <div class="card p-5">
      <div class="text-xs text-gray-500">Question ${idx+1} of ${quizState.order.length} ${itm.domain? '• '+itm.domain:''}</div>
      <div class="mt-2 font-medium">${escapeHTML(itm.question)}</div>
      <div class="mt-3 grid md:grid-cols-2 gap-2">
        ${['A','B','C','D'].map(k=> itm.options?.[k]? `
          <label class='flex gap-2 items-start border rounded-xl p-2 cursor-pointer hover:bg-blue-50'>
            <input type='radio' name='qsel' value='${k}' class='mt-1'>
            <div><div class='text-sm'><span class='text-gray-500 mr-1'>${k}.</span><b>${escapeHTML(itm.options[k])}</b></div></div>
          </label>`:'').join('')}
      </div>
      <div class="mt-4 flex gap-2">${idx>0? `<button class="btn" onclick="quizPrev()"><b>Back</b></button>`:''}<button class="btn btn-primary" onclick="quizNext()"><b>${idx===quizState.order.length-1? 'Finish':'Next'}</b></button></div>
    </div>`;
  const prev=quizState.answers[idx]; if(prev){ const sel=document.querySelector(`input[name='qsel'][value='${prev}']`); if(sel) sel.checked=true; }
}
function quizPrev(){ if(!quizState) return; saveCurrent(); if(quizState.idx>0) quizState.idx--; renderQuizLive(); }
function quizNext(){ if(!quizState) return; saveCurrent(); if(quizState.idx<quizState.order.length) quizState.idx++; renderQuizLive(); }
function saveCurrent(){ const idx=quizState.idx; const sel=document.querySelector("input[name='qsel']:checked"); quizState.answers[idx]=sel? sel.value:''; }
function reviewLastResult(id){ const res=results.find(r=>r.id===id)||results[0]; if(!res){ toast('No results to review.','warn'); return;} const wrap=document.getElementById('quizLive'); wrap.innerHTML = res.detail.map((d,idx)=>{ const itm=itemsFull.find(x=>x.id===d.qid); if(!itm) return ''; const correct = d.user===itm.answer; return `
  <div class="card p-4 mb-3 ${correct? 'border-green-300':'border-red-300'}">
    <div class="text-xs text-gray-500">Q${idx+1}${itm.domain? ' • '+itm.domain:''}</div>
    <div class="font-medium mt-1">${escapeHTML(itm.question)}</div>
    <div class='mt-2 text-sm'><span class='text-gray-500'>Your answer:</span> ${d.user||'(none)'} • <span class='text-gray-500'>Correct:</span> ${itm.answer}</div>
    <ol class='mt-2 grid grid-cols-2 gap-2 text-sm'>${['A','B','C','D'].map(k=> itm.options?.[k]? `<li class='border rounded-lg px-2 py-1'><span class='text-gray-500 mr-1'>${k}.</span>${escapeHTML(itm.options[k])}</li>`:'').join('')}</ol>
    ${itm.rationale? `<div class='mt-2 text-sm text-gray-700'><span class='text-gray-600'>Rationale:</span> ${escapeHTML(itm.rationale)}</div>`:''}
  </div>`; }).join('') + `<div class='mt-4 flex gap-2'><button class='btn btn-primary' onclick='startQuiz()'><b>Retake Quiz</b></button><button class='btn' onclick="showPanel('panel-results')"><b>Go to Data</b></button></div>`; }

// ====== Data Panel ======
function renderData(){
  const el=document.getElementById('panel-results');
  el.innerHTML=`
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Data & Results</h2>
      <div class="flex gap-2">
        <button class="btn" onclick="downloadJSON()"><b>Export JSON</b></button>
        <button class="btn" onclick="downloadCSV_Full()"><b>Full CSV</b></button>
        <button class="btn" onclick="downloadCSV_Flash()"><b>Flash CSV</b></button>
        <button class="btn" onclick="clearAll()"><b>Clear Data</b></button>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="font-medium mb-2">Quiz History (${results.length})</div>
        <div id="hist"></div>
      </div>
      <div class="card p-4">
        <div class="font-medium mb-2">Deck Summary</div>
        <div class="text-sm text-gray-700">Full Deck: ${itemsFull.length} • Flash Cards: ${itemsFlash.length}</div>
        <div class="mt-2 text-sm" id="byDomain"></div>
      </div>
    </div>`;
  const hist=document.getElementById('hist');
  hist.innerHTML = results.map(r=>`<div class='flex items-center justify-between border-b py-2 text-sm'><div><div>${new Date(r.date).toLocaleString()}</div><div class='text-gray-500'>Domain: ${r.domain||'All'} • Time: ${r.elapsed}s</div></div><div class='font-medium'>${r.score}/${r.total}</div></div>`).join('') || '<div class="text-sm text-gray-500">No results yet.</div>';
  const map={}; for(const i of itemsFull){ map[i.domain||'Untitled']=(map[i.domain||'Untitled']||0)+1; }
  document.getElementById('byDomain').innerHTML = Object.entries(map).map(([d,c])=>`<div class='flex items-center justify-between border-b py-1 text-sm'><div>${escapeHTML(d)}</div><div>${c}</div></div>`).join('') || '<div class="text-sm text-gray-500">No full-deck items.</div>';
}

// ====== Helpers & Export ======
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]]; } return a; }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function download(name, content, type='text/plain'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); }
function downloadJSON(){ download('myaba_data.json', JSON.stringify({full: itemsFull, flash: itemsFlash, results}, null, 2), 'application/json'); }
function toCSV_Full(){ const header=['domain','question','a','b','c','d','answer','rationale']; const rows=itemsFull.map(i=>[i.domain||'',i.question||'',i.options?.A||'',i.options?.B||'',i.options?.C||'',i.options?.D||'',i.answer||'',i.rationale||''].map(v=>{ v=v==null?'':String(v); if(/[",\n]/.test(v)) v='"'+v.replace(/"/g,'""')+'"'; return v; }).join(',')); return [header.join(','),...rows].join('\n'); }
function toCSV_Flash(){ const header=['term','definition']; const rows=itemsFlash.map(i=>[i.question||'', i.answer||''].map(v=>{ v=v==null?'':String(v); if(/[",\n]/.test(v)) v='"'+v.replace(/"/g,'""')+'"'; return v; }).join(',')); return [header.join(','),...rows].join('\n'); }
function downloadCSV_Full(){ download('myaba_full.csv', toCSV_Full(), 'text/csv'); }
function downloadCSV_Flash(){ download('myaba_flash.csv', toCSV_Flash(), 'text/csv'); }
function getTemplateFull(){ return 'domain,question,a,b,c,d,answer,rationale\n'; }
function getTemplateFlash(){ return 'term,definition\n'; }
function downloadTemplateFull(){ download('template_full.csv', getTemplateFull(), 'text/csv'); }
function downloadTemplateFlash(){ download('template_flash.csv', getTemplateFlash(), 'text/csv'); }
function emptyState(msg){ return `<div class='text-center py-10 text-gray-500'>${msg}</div>`; }

// ====== File Inputs & Sample ======
const fileFull=document.getElementById('fileInputFull');
const fileFlash=document.getElementById('fileInputFlash');
fileFull.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const rows=parseCSV(text); const newItems=rowsToItems_Full(rows); if(!newItems.length) throw new Error('No rows found.'); itemsFull=mergeItems(itemsFull,newItems); save(); renderAll(); toast(`Imported ${newItems.length} full-deck items.`,'ok'); }catch(err){ toast('Import failed: '+err.message,'error'); } fileFull.value=''; });
fileFlash.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const rows=parseCSV(text); const newItems=rowsToItems_FlashOnly(rows); if(!newItems.length) throw new Error('No rows found.'); itemsFlash=mergeItems(itemsFlash,newItems); save(); renderAll(); toast(`Imported ${newItems.length} flash terms.`,'ok'); }catch(err){ toast('Import failed: '+err.message,'error'); } fileFlash.value=''; });

const SAMPLE_CSV = 'domain,question,a,b,c,d,answer,rationale\nGeneral,During discrete-trial teaching the intertrial interval is...,Time between SD and response,Time between reinforcement and the next SD,Time between two responses,Time before data recording,B,The ITI separates reinforcement delivery and the next SD.\n';
const btnLoadSample=document.getElementById('btnLoadSample');
const btnClear=document.getElementById('btnClear');
const btnTplFull=document.getElementById('btnTplFull');
const btnTplFlash=document.getElementById('btnTplFlash');
if(btnLoadSample) btnLoadSample.addEventListener('click', ()=>{ try{ const rows=parseCSV(SAMPLE_CSV); const newItems=rowsToItems_Full(rows); itemsFull=mergeItems(itemsFull,newItems); save(); renderAll(); toast(`Sample loaded: ${newItems.length} item(s)`,'ok'); }catch(err){ toast('Sample load failed: '+err.message,'error'); } });
if(btnClear) btnClear.addEventListener('click', clearAll);
if(btnTplFull) btnTplFull.addEventListener('click', downloadTemplateFull);
if(btnTplFlash) btnTplFlash.addEventListener('click', downloadTemplateFlash);

function renderAll(){ if(document.getElementById('panel-decks')) renderDecks(); if(document.getElementById('panel-results')) renderData(); if(document.getElementById('panel-flash')){ flashOrder=[]; flashIndex=0; renderFlash(); } }

// ====== Self Tests ======
function runSelfTests(){
  const errs=[];
  try{ // Flash parse
    const rows=parseCSV('term,definition\nStimulus,An energy change\n');
    const fx=rowsToItems_FlashOnly(rows);
    if(fx.length!==1 || fx[0].type!=='FLASH' || fx[0].question!=='Stimulus') throw new Error('Flash parse');
  }catch(e){ errs.push('Flash parse failed'); }
  try{ // Full parse + uppercase answer
    const csv='domain,question,a,b,c,d,answer,rationale\nGen,What?,Opt1,Opt2,Opt3,Opt4,a,Because\n';
    const rows=parseCSV(csv);
    const full=rowsToItems_Full(rows);
    if(full.length!==1 || full[0].type!=='MC' || full[0].answer!=='A') throw new Error('Full parse/uppercase');
  }catch(e){ errs.push('Full parse failed'); }
  try{ // Quoted commas
    const rows=parseCSV('term,definition\n"A, B, C","alpha, beta"\n');
    if(rows[1][0]!=='A, B, C' || rows[1][1]!=='alpha, beta') throw new Error('CSV quoting');
  }catch(e){ errs.push('CSV quoting failed'); }
  try{ // Dedup
    const a=[{type:'FLASH',question:'X'}];
    const b=[{type:'FLASH',question:'X'}];
    const m=mergeItems(a,b);
    if(m.length!==1) throw new Error('Dedup');
  }catch(e){ errs.push('Dedup failed'); }
  try{ // showPanel wiring
    showPanel('panel-flash');
    const pf=document.getElementById('panel-flash');
    const ph=document.getElementById('panel-home');
    if(pf.classList.contains('hidden') || !ph.classList.contains('hidden')) throw new Error('ShowPanel');
  }catch(e){ errs.push('showPanel failed'); }
  try{ // Templates end with newline
    if(!getTemplateFull().endsWith('\n') || !getTemplateFlash().endsWith('\n')) throw new Error('Template newline');
  }catch(e){ errs.push('Templates missing newline'); }
  // reset to home so UI looks expected
  showPanel('panel-home');
  if(errs.length){ toast('Self-tests: '+errs.join(' • '),'warn'); }
  else{ toast('Self-tests passed','ok'); }
}

// ====== Boot ======
load();
renderTabs();
showPanel('panel-home');
renderAll();
runSelfTests();
</script>
</body>
</html>
