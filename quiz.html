<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>myABA • Quiz</title>
  <link rel="stylesheet" href="/assets/style.css"/>
  <style>
    /* Lightweight overrides for quiz feedback */
    .btn{ transition: background .15s ease, border-color .15s ease }
    .btn.ok{ background:#dcfce7; border-color:#86efac }        /* green */
    .btn.bad{ background:#fee2e2; border-color:#fecaca }       /* red */
    .btn.correct{ outline:2px solid #16a34a }
    .btn.disabled, .btn:disabled{ opacity:.6; cursor:not-allowed }
    #q-feedback{ display:none; border:1px solid #e2e8f0 }
    #q-feedback.ok{ display:block; background:#ecfdf5; border-color:#86efac; }
    #q-feedback.bad{ display:block; background:#fef2f2; border-color:#fecaca; }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner container">
      <div style="display:flex;align-items:center;gap:10px">
        <a href="/" class="brand" style="font-weight:700;color:#0ea5e9">myABA</a>
        <span class="muted">study suite</span>
      </div>
      <div style="display:flex;gap:6px">
        <a href="/">Home</a>
        <a href="/flashcards.html">Flashcards</a>
        <a href="/safmeds.html">SAFMEDS</a>
        <a href="/quiz.html" class="active">Quiz</a>
        <a href="/data.html">Data</a>
        <a href="/settings.html">Settings</a>
      </div>
    </div>
  </nav>

  <main class="container grid">
    <section class="card">
      <h1>Quiz</h1>
      <p class="muted">Choose an answer to see the rationale. The rationale stays until you click <strong>Next</strong>.</p>
    </section>

    <section class="card" id="quiz-area">
      <div id="q-txt" style="font-weight:600; margin-bottom:8px">Question will appear here</div>
      <div id="q-domain" class="muted" style="margin:-6px 0 10px 0"></div>
      <div class="grid" style="grid-template-columns:1fr; gap:8px">
        <button class="btn" data-opt="A">A</button>
        <button class="btn" data-opt="B">B</button>
        <button class="btn" data-opt="C">C</button>
        <button class="btn" data-opt="D">D</button>
      </div>
      <div id="q-feedback" class="card" style="margin-top:12px; padding:12px"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="next" class="btn" disabled>Next →</button>
      </div>
    </section>
  </main>

  <footer>© 2025 myABA</footer>
  <script src="/assets/app.js"></script>
  <script>
    const st = { i:0, deck:[], answered:false };

    const elQ = document.getElementById('q-txt');
    const elD = document.getElementById('q-domain');
    const fb  = document.getElementById('q-feedback');
    const nextBtn = document.getElementById('next');
    const btns = Array.from(document.querySelectorAll('[data-opt]'));

    function labelOf(r, k){
      return (r['option'+k] ?? r['option'+k.toLowerCase()] ?? '') || '';
    }

    function clearButtons(){
      btns.forEach(b => {
        b.classList.remove('ok','bad','correct');
        b.disabled = false;
        const k = b.getAttribute('data-opt');
        b.textContent = k + ': ';
      });
      fb.classList.remove('ok','bad');
      fb.style.display = 'none';
      fb.textContent = '';
      nextBtn.disabled = true;
      st.answered = false;
    }

    function show(){
      if(!st.deck.length){
        elQ.textContent = 'No quiz deck loaded. Upload a CSV on the Data page first.';
        elD.textContent = '';
        btns.forEach(b => { b.disabled = true; b.textContent = b.getAttribute('data-opt'); });
        nextBtn.disabled = true;
        return;
      }
      const r = st.deck[st.i];
      elQ.textContent = r.question || '';
      elD.textContent = r.domain ? ('Domain: ' + r.domain) : '';
      clearButtons();
      // Fill choices
      btns.forEach(b => {
        const k = b.getAttribute('data-opt');
        b.textContent = k + ': ' + labelOf(r,k);
      });
    }

    function answer(pick){
      if(st.answered) return;
      const r = st.deck[st.i];
      const correct = (r.answer || '').toString().trim().toUpperCase() || 'A';
      const ok = (pick === correct);

      // mark picked
      const pickedBtn = btns.find(b => b.getAttribute('data-opt') === pick);
      if (pickedBtn){ pickedBtn.classList.add(ok ? 'ok' : 'bad'); }

      // highlight the correct option
      const correctBtn = btns.find(b => b.getAttribute('data-opt') === correct);
      if (correctBtn){ correctBtn.classList.add('correct'); }

      // show rationale, persist until Next
      fb.textContent = (ok ? '✅ Correct. ' : '❌ Incorrect. ') + (r.rationale || '');
      fb.classList.add(ok ? 'ok' : 'bad');
      fb.style.display = 'block';

      // lock buttons; enable Next
      btns.forEach(b => b.disabled = true);
      nextBtn.disabled = false;
      st.answered = true;
    }

    btns.forEach(b => b.addEventListener('click', () => answer(b.getAttribute('data-opt'))));
    nextBtn.addEventListener('click', () => {
      st.i = (st.i + 1) % st.deck.length;
      show();
    });

    // Load deck
    try {
      const { qz } = (typeof loadLocalDecks === 'function') ? loadLocalDecks() : { qz: [] };
      st.deck = Array.isArray(qz) ? qz : [];
    } catch(e){ st.deck = []; }
    show();
  </script>
</body>
</html>
